<!-- 
  TODO
  - Faltan algunas tablas por hipervinculo
  - Estilos link columna documentos y clientes
  - Todo lo relacionado con graficas y mapas
  - Selección de fecha
  - Funcionalidad exportar dashboard
 -->


<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="shortcut icon" type="image/x-icon" href="https://app.pedbox.co/assets/logos/logo_blanco.png"/>
  <title> Dashboard </title>

  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700" rel="stylesheet" />
  <link href="/css/nucleo-svg.css" rel="stylesheet" />
  <link href="/css/nucleo-icons.css" rel="stylesheet" />
  <link href="/css/nucleo-svg.css" rel="stylesheet" />
  <link id="pagestyle" href="/css/soft-ui-dashboard.css?v=1.0.3" rel="stylesheet" />
  <link rel="stylesheet" href="/css/jquery-ui.min.css">
  <link rel="stylesheet" href="/css/reports.css">

  <script src="https://kit.fontawesome.com/42d5adcbca.js" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.1.0/socket.io.js" integrity="sha512-+l9L4lMTFNy3dEglQpprf7jQBhQsQ3/WvOnjaN/+/L4i0jOstgScV0q2TjfvRF4V+ZePMDuZYIQtg5T4MKr+MQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="/js/jquery.js"></script>
  <script src="/js/helpers.js"></script>

  <!-- Color Page -->
  <%- include('./partials/colors.ejs') %> 

  <style>
    #cardsContainerDashboard>div{
      flex: 1 1 0px
    }  
    #cardsContainerDashboard p{
      margin: 0;
    }  
    #cardsContainerDashboard h4{
      font-size: 20px !important;
    }
    .dashboardNumberStyle{
      color: #344767 !important;
      font-weight: 700;
    }
    #cardsContainerDashboard h2{
      font-size: 25px !important;
    }
    #headerDashboard i{
      cursor: pointer;
    }
    .imgTable{
      max-width: 100%;
      max-height: 100%;
      border-radius: 50%;
      overflow: hidden;
    }
    .imgTableCont{
      width: 35px;
      height: 35px;
    }
    tr th a{
      text-align: center !important;
    }
    .dataTable-sorter::before {
      display: none !important;
    }
    .dataTable-sorter::after {
      display: none !important;
    }

  </style>
</head>

<body class="g-sidenav-show bg-gray-100">

  <!-- Menu -->
  <%- include('./partials/menu.ejs') %> 

  <main class="main-content max-height-vh-100 h-100">

    <!-- Cabecera -->
    <%- include('./partials/header.ejs') %>
  
      <!-- Cotent -->
      <div class="p-4">

        <div id="headerDashboard" class="card mb-2 flex-row align-items-center" style="background-color: transparent; box-shadow: none;"> 
          <div class="w-50 ms-3">
            <span class="font-weight-bold" style="color: #344767; font-style: italic;">Abril 1 del 2020</span>
            <i class="fas fa-pen ms-3" data-toggle="tooltip" title="Editar Fecha"></i>
            <i class="fas fa-download ms-3" data-toggle="tooltip" title="Exportar Dashboard"></i>
          </div>

          <div class="w-50 nav-wrapper position-relative end-0">
            <ul class="nav nav-pills nav-fill p-1 bg-transparent" role="tablist">
              <li class="nav-item">
                <a class="nav-link mb-0 px-0 py-1 active " data-bs-toggle="tab" href="javascript:;" role="tab" aria-selected="true">
                  <i class="fas fa-table"></i>
                  <span class="ms-1">Tablas</span>
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link mb-0 px-0 py-1 " data-bs-toggle="tab" href="javascript:;" role="tab" aria-selected="false">
                  <i class="fas fa-chart-bar"></i>
                  <span class="ms-1">Gráficas</span>
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link mb-0 px-0 py-1 " data-bs-toggle="tab" href="javascript:;" role="tab" aria-selected="false">
                  <i class="fas fa-map-marked"></i>
                  <span class="ms-1">Mapas</span>
                </a>
              </li>

            </ul>
          </div>
        </div>

        <div id="cardsContainerDashboard" class="d-flex">
          <div class="d-flex gap-3 justify-content-center px-1">
            <div class="card flex-fill  cardsButtons" style="width: 25%; cursor: pointer">
              <div class=" h-100">
                <div class="card-header p-3 pb-0" style="background-color: transparent">
                  <div class="d-flex justify-content-between">
                    <h6 class="mb-0">Ventas</h6>
                  </div>
                  <div class="text-center">
                    <h2 style="color: #03A9F4"> <span id="dsboardVentas">0</span></h2>
                    <h4>Total</h4>
                  </div> 
                </div>
                <div class="card-body p-3 py-1 d-flex justify-content-center align-items-center flex-column"  >
                  <div style="width: 100%; margin-top: 20px" >   
                    <div class="border-top" style="padding: 5px 10px">   
                      <p class="mt-1">Clientes visitados:  <span id="dsboardClientesVisitados" class="dashboardNumberStyle">0</span> </p>
                    </div>
                    <div class="border-top" style="padding: 5px 10px">    
                      <p class="mt-1">Productos:  <span id="dsboardProducts" class="dashboardNumberStyle">0</span> </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="d-flex gap-3 justify-content-center px-1">
            <div class="card flex-fill  cardsButtons" style="width: 25%; cursor: pointer">
              <div class=" h-100">
                <div class="card-header p-3 pb-0" style="background-color: transparent">
                  <div class="d-flex justify-content-between">
                    <h6 class="mb-0">Vendedores</h6>
                  </div>
                  <div class="text-center">
                    <h2 style="color: #388E3C"> <span id="dsboardVendedores">0</span></h2>
                    <h4>Activos</h4>
                  </div> 
                </div>
                <div class="card-body p-3 py-1 d-flex justify-content-center align-items-center flex-column"  >
                  <div style="width: 100%; margin-top: 20px" >   
                    <div class="border-top" style="padding: 5px 10px">   
                      <p class="mt-1">Registrados:  <span id="dsboardRegistered" class="dashboardNumberStyle">0</span> </p>
                    </div>

                    <div class="border-top" style="padding: 5px 10px">    
                      <p class="mt-1">Promedio ventas:  <span id="dsboardPromedioVentas" class="dashboardNumberStyle">0</span> </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="d-flex gap-3 justify-content-center px-1">
            <div class="card flex-fill  cardsButtons" style="width: 25%; cursor: pointer">
              <div class=" h-100">
                <div class="card-header p-3 pb-0" style="background-color: transparent">
                  <div class="d-flex justify-content-between">
                    <h6 class="mb-0">Documentos</h6>
                  </div>
                  <div class="text-center">
                    <h2 style="color: #FF9801"> <span id="dsboardDocuments">0</span></h2>
                    <h4>Cantidad</h4>
                  </div> 
                </div>
                <div class="card-body p-3 py-1 d-flex justify-content-center align-items-center flex-column"  >
                  <div style="width: 100%; margin-top: 20px" >   
                    <div class="border-top" style="padding: 5px 10px">   
                      <p class="mt-1">Pedidos:  <span id="dsboardPedidos" class="dashboardNumberStyle">0</span> </p>
                    </div>
                    <div class="border-top" style="padding: 5px 10px">    
                      <p class="mt-1">Facturas:  <span id="dsboardFacturas" class="dashboardNumberStyle">0</span> </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="card mt-2 p-2">
          <div id="tablesDashboard">

            <div id="tableRanking">
              <h6 class="mb-0 ms-2">Ranking Vendedores</h6>
              <table id="tRanking">
                <thead style="table-layout: fixed;">
                  <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder"></th>
                  <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder">Nombres</th>
                  <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder">Clientes</th>
                  <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder">Documentos</th>
                  <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder">Bodega</th>
                  <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder">Total</th>
                </thead>
                <tbody id="tBodyRanking"></tbody>
              </table>
            </div>

            <div id="tableDocuments" style="display: none;">
              <h6 class="mb-0 ms-2">Documentos</h6>
              <table id="tDocuments">
                <thead style="table-layout: fixed;">
                  <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder">Vendedor</th>
                  <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder">Cliente</th>
                  <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder">Documento</th>
                  <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder">Valor</th>
                  <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder">Fecha</th>
                  <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder">Tipo</th>
                  <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder">Nota</th>
                </thead>
                <tbody id="tBodyDocuments"></tbody>
              </table>
            </div>

            <div id="tableVisits" style="display: none;">
              <h6 class="mb-0 ms-2">Clientes Visitados</h6>
              <table id="tVisits">
                <thead style="table-layout: fixed;">
                  <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder">Nit</th>
                  <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder">Cliente</th>
                  <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder">Documentos</th>
                  <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder">Total</th>
                </thead>
                <tbody id="tBodyVisits"></tbody>
              </table>
            </div>

            <div id="tableProducts" style="display: none;">
              <h6 class="mb-0 ms-2">Productos</h6>
              <table id="tProducts">
                <thead style="table-layout: fixed;">
                  <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder">Producto</th>
                  <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder">Descripción</th>
                  <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder">Cantidad</th>
                </thead>
                <tbody id="tBodyProducts"></tbody>
              </table>
            </div>

          </div>
        </div>

      </div>

      <!-- Modales -->
      <div id="modalTablesDocuments" class="modal fade" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document" style="min-width: 80vw !important;">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="modalTitleDocuments">a</h5>
              <div class="d-flex justify-content-center align-items-center gap-2">
                <button onclick="$('#modalTablesDocuments').modal('hide')" type="button" class="btn-close rounded-circle me-1" style="background-color: gray"></button>
              </div>
            </div>
            <div class="modal-body">
              
              <div id="tableDocumentsModal">
                <table id="tDocumentsModal">
                  <thead style="table-layout: fixed;">
                    <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder">Vendedor</th>
                    <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder">Cliente</th>
                    <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder">Documento</th>
                    <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder">Valor</th>
                    <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder">Fecha</th>
                    <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder">Tipo</th>
                    <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder">Nota</th>
                  </thead>
                  <tbody id="tBodyDocumentsModal"></tbody>
                </table>
              </div>

            </div>
          </div>
        </div>
      </div>

      <div id="modalTablesClients" class="modal fade" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document" style="min-width: 80vw !important;">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="modalTitleClients">a</h5>
              <div class="d-flex justify-content-center align-items-center gap-2">
                <button onclick="$('#modalTablesClients').modal('hide')" type="button" class="btn-close rounded-circle me-1" style="background-color: gray"></button>
              </div>
            </div>
            <div class="modal-body">
              
              <div id="tableClientsModal">
                <table id="tClientsModal">
                  <thead style="table-layout: fixed;">
                    <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder">Nit</th>
                    <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder">Cliente</th>
                    <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder">Documentos</th>
                    <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder">Total</th>
                  </thead>
                  <tbody id="tBodyClientsModal"></tbody>
                </table>
              </div>

            </div>
          </div>
        </div>
      </div>

      <!-- preloader -->
      <%- include('./partials/preloader.ejs') %> 
      
  </main>


  <!-- Scripts -->
  <script src="/js/core/popper.min.js"></script>
  <script src="/js/core/bootstrap.min.js"></script>
  <script src="/js/plugins/perfect-scrollbar.min.js"></script>
  <script src="/js/plugins/smooth-scrollbar.min.js"></script>
  <script src="/js/plugins/choices.min.js"></script>
  <script src="/js/soft-ui-dashboard.min.js?v=1.0.3"></script>
  <script src="/js/plugins/dragula/dragula.min.js"></script>
  <script src="/js/plugins/jkanban/jkanban.js"></script>
  <script src="/js/jquery-ui.min.js"></script>
  <script src="/js/plugins/datatables.js"></script>
  <script src="/js/plugins/chartjs.min.js"></script>
  <script src="/js/underscore-min.js"></script>
  <script src="/js/menu.js"></script>
    
  <script>
    let startDateDashboard = new Date().toISOString().split("T")[0].replaceAll("-", "");
    let endDateDashboard = new Date().toISOString().split("T")[0].replaceAll("-", "");
    let dataDashboard;
    let dataSellers;
    let dataProducts;
    let personsCompany;
    let dataSellersVisits;

    const getData = (user) => {
      let userID = user || 0;
      fetch(`/dashboard/data/${startDateDashboard}/${endDateDashboard}/${userID}`)
      .then(res => res.json())
      .then(res => {
        dataDashboard = res[0];
        dataSellers = res[1];
        dataProducts = res[2];
        personsCompany = res[3].result.persons;
        dataSellersVisits = res[4];

        printDataReports(dataDashboard.result.report[0])
        printTableRanking(dataDashboard.result.detail)
        printTableDocuments(dataSellers.result.report)
        printTablevisits(dataSellersVisits.result.report)
        printTableProducts(dataProducts.result.report)
      })
    };

    let getDocumentsSeller = (user, name) => {
      fetch(`/dashboard/reportSeller/${startDateDashboard}/${endDateDashboard}/${user}`)
      .then(res => res.json())
      .then(res => {
        if (!res.result.success) return
        
        printTableDocumentsModal(res.result.report);

        $("#modalTitleDocuments").html("Documentos realizados por "+name)
        $("#modalTablesDocuments").modal("show")
      })
    }

    let getClientsSeller = (user, name) => {
      fetch(`/dashboard/clientsSeller/${startDateDashboard}/${endDateDashboard}/${user}`)
      .then(res => res.json())
      .then(res => {
        if (!res.result.success) return

        console.log(res)
        
        printTableClientsModal(res.result.report);

        $("#modalTitleClients").html("Clientes de "+name)
        $("#modalTablesClients").modal("show")
      })
    }

    const printDataReports = (data) => {
      $("#dsboardVentas").html(nvFormatCash(data.ventas).split(".")[0])
      $("#dsboardClientesVisitados").html(data.clientes)
      $("#dsboardProducts").html(data.productos)
      $("#dsboardVendedores").html(data.vendedores)
      $("#dsboardRegistered").html(data.registrados)
      $("#dsboardPromedioVentas").html(data.ventas) // TODO de donde saco este dato
      $("#dsboardDocuments").html(data.documentos)
      $("#dsboardPedidos").html(data.pedidos)
      $("#dsboardFacturas").html(data.facturas)
    }

    let tblRanking;
    const printTableRanking = (data) => {
      data = _.sortBy(data, function(o) { return o.valor; }).reverse()

      for (let i = 0; i < data.length; i++) {
        let user = _.findWhere(personsCompany, {num_identification: data[i].nit});

        let element = `
          <tr>
            <td class="text-center">#${i+1}</td>
            <td class="text-center">
              <div class="d-flex gap-2 align-items-center">
                <div class="imgTableCont"><img src="${(user.photo ? "https://api.pedbox.co:8590"+user.photo : "https://app.pedbox.co/assets/images/avatars/profile.jpg")}" alt="" class="imgTable"></div>
                ${user.name_person}
              </div>  
            </td>
            <td class="text-center" onclick="getClientsSeller(${data[i].nit}, '${user.name_person}')">${data[i].clientes || "-"}</td>
            <td class="text-center" onclick="getDocumentsSeller(${data[i].nit}, '${user.name_person}')">${data[i].cantidad || "-"}</td>
            <td class="text-center">${data[i].bodega || "-"}</td>
            <td class="text-center">${nvFormatCash(data[i].valor).split(".")[0] || "-"}</td>
          </tr>
        `;
        $("#tBodyRanking").append(element)
      }

      tblRanking = new simpleDatatables.DataTable("#tRanking", {
        perPageSelect: false
      });
    }

    let tblDocuments;
    const printTableDocuments = (data) => {
      for (let i = 0; i < data.length; i++) {
        let user = _.findWhere(personsCompany, {num_identification: data[i].vendedor});

        let element = `
          <tr>
            <td class="text-center">${user.name_person}</td>
            <td class="text-center">${data[i].cliente || "-"}</td>
            <td class="text-center">${data[i].documento}</td>
            <td class="text-center">${data[i].valor || "-"}</td>
            <td class="text-center">${new Date(data[i].fecha).toLocaleString() || "-"}</td>
            <td class="text-center">${data[i].tipo_doc}</td>
            <td class="text-center">${data[i].nota || "-"}</td>
          </tr>
        `;
        $("#tBodyDocuments").append(element)
      }

      tblDocuments = new simpleDatatables.DataTable("#tDocuments", {
        perPageSelect: false
      });
    }

    let tblDocumentsModal;
    const printTableDocumentsModal = (data) => {
      try {
        tblDocumentsModal.destroy();
      } catch (error) {}
      $("#tBodyDocumentsModal").html("")

      for (let i = 0; i < data.length; i++) {
        let user = _.findWhere(personsCompany, {num_identification: data[i].vendedor});

        let element = `
          <tr>
            <td class="text-center">${user.name_person}</td>
            <td class="text-center">${data[i].cliente || "-"}</td>
            <td class="text-center">${data[i].documento}</td>
            <td class="text-center">${data[i].valor || "-"}</td>
            <td class="text-center">${new Date(data[i].fecha).toLocaleString() || "-"}</td>
            <td class="text-center">${data[i].tipo_doc}</td>
            <td class="text-center">${data[i].nota || "-"}</td>
          </tr>
        `;
        $("#tBodyDocumentsModal").append(element)
      }

      tblDocumentsModal = new simpleDatatables.DataTable("#tDocumentsModal", {
        perPageSelect: false
      });
    };

    let tblClientsModal;
    const printTableClientsModal = (data) => { // TODO
      try {
        tblClientsModal.destroy();
      } catch (error) {}
      $("#tBodyClientsModal").html("")

      console.log(data)

      for (let i = 0; i < data.length; i++) {
        let element = `
          <tr>
            <td class="text-center">${data[i].nit}</td>
            <td class="text-center">${data[i].cliente || "-"}</td>
            <td class="text-center">${data[i].documentos}</td>
            <td class="text-center">${nvFormatCash(data[i].total).split(".")[0]  || "-"}</td>
          </tr>
        `;
        $("#tBodyClientsModal").append(element)
      }

      tblClientsModal = new simpleDatatables.DataTable("#tClientsModal", {
        perPageSelect: false
      });
    };

    let tblvisits;
    const printTablevisits = (data) => {
      for (let i = 0; i < data.length; i++) {
        let element = `
          <tr>
            <td class="text-center">${data[i].nit || "-"}</td>
            <td class="text-center">${data[i].cliente || "-"}</td>
            <td class="text-center">${data[i].documentos  || "-"}</td>
            <td class="text-center">${nvFormatCash(data[i].total).split(".")[0] || "-"}</td>
          </tr>
        `;
        $("#tBodyVisits").append(element)
      }

      tblvisits = new simpleDatatables.DataTable("#tVisits", {
        perPageSelect: false
      });
    }

    let tblProducts;
    const printTableProducts = (data) => {
      for (let i = 0; i < data.length; i++) {
        let element = `
          <tr>
            <td class="text-center">${data[i].producto || "-"}</td>
            <td class="text-center">${data[i].descripcion || "-"}</td>
            <td class="text-center">${data[i].cantidad  || "-"}</td>
          </tr>
        `;
        $("#tBodyProducts").append(element)
      }

      tblProducts = new simpleDatatables.DataTable("#tProducts", {
        perPageSelect: false
      });
    }




    


    $(document).ready(function () {
      $('[data-toggle="tooltip"]').tooltip()
      $("#menuDashboard").addClass("activeNav")
      $("#preloader").hide();

      getData()
    })
  </script>

</body>
</html>